unit UNSReport;

interface

uses
  System.Classes,
  System.Generics.Collections,
  System.TypInfo,
  System.SysUtils,
  Vcl.Controls,
  Vcl.Graphics,
  UNSReportBand;

type
  TNSReport = class(TCustomControl)
  private
    FBands: TObjectList<TNSReportBand>;
    procedure ArrangeBands;
  protected
    procedure Paint; override;
    procedure Resize; override;
    procedure Loaded; override;
    function GenerateBandName(ABandType: TNSReportBandType): string;
    function HasBand(ABandType: TNSReportBandType): Boolean;
  public
    constructor Create(AOwner: TComponent); override;
    destructor Destroy; override;

    function AddBand(ABandType: TNSReportBandType): TNSReportBand;

  published
    { published declarations }
  end;

implementation



{ TNSReport }

function TNSReport.AddBand(ABandType: TNSReportBandType): TNSReportBand;
var
  BaseName: string;
  UniqueName: string;
  Suffix: Integer;
begin
  Result := TNSReportBand.Create(Self);
  Result.BandType := ABandType;

  // Generamos el name del component
  Result.Name := GenerateBandName(ABandType);

  if csDesigning in ComponentState then
    Owner.InsertComponent(Result);

  Result.Parent := Self; // visual
  FBands.Add(Result);

  ArrangeBands;
end;

procedure TNSReport.ArrangeBands;
var
  i: Integer;
  TopPos: Integer;
begin
  TopPos := 0;
  for i := 0 to FBands.Count - 1 do
  begin
    FBands[i].SetBounds(0, TopPos, Width, FBands[i].Height);
    TopPos := TopPos + FBands[i].Height;
  end;

end;

constructor TNSReport.Create(AOwner: TComponent);
begin
  inherited Create(AOwner);
  FBands := TObjectList<TNSReportBand>.Create(True);
  Width := 400;
  Height := 300;
  Color := clBtnFace;

end;

destructor TNSReport.Destroy;
begin
  FBands.Free;
  inherited;
end;

function TNSReport.GenerateBandName(ABandType: TNSReportBandType): string;
begin
  Result := 'Band_' + Name + '_' + GetEnumName(TypeInfo(TNSReportBandType), Ord(ABandType));
end;

function TNSReport.HasBand(ABandType: TNSReportBandType): Boolean;
var
  i: Integer;
  ExpectedName: string;
begin
  ExpectedName := GenerateBandName(ABandType);
  for i := 0 to ComponentCount - 1 do
  begin
    if (Components[i] is TNSReportBand) and
       (CompareText(Components[i].Name, ExpectedName) = 0) then
      Exit(True);
  end;
  Result := False;
end;

procedure TNSReport.Loaded;
begin
  inherited;

  if csDesigning in ComponentState then
  begin
    if not HasBand(rbReportHeader) then
    begin
      AddBand(rbReportHeader);
      AddBand(rbPageHeader);
      AddBand(rbColumnHeader);
      AddBand(rbDetail);
      AddBand(rbDetailFooter);
      AddBand(rbPageFooter);
      AddBand(rbReportFooter);
    end;
  end;
end;

procedure TNSReport.Paint;
begin
  inherited;
  // No dibujamos directamente; las bandas son controles hijos y se dibujan solas.
end;

procedure TNSReport.Resize;
begin
  inherited;
  ArrangeBands;
end;

end.
